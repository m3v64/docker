auth:
  secret-key: ${GLANCE_SECRET_KEY}
  users:
    m3v:
      password: ${GLANCE_ADMIN_PASSWORD}

server:
  proxied: true
  port: 9080

branding:
  custom-footer: |
    <p><a href="hhttps://tenor.com/gtVhAKD3kmt.gif">Powered by Water</a></p>

theme:
  background-color: 50 1 6
  primary-color: 157 47 65
  contrast-multiplier: 1.4
  positive-color: 165 83 85
  negative-color: 240 21 32
  disable-picker: false

  presets:
    mint:
      background-color: 186 21 20
      contrast-multiplier: 1.2
      primary-color: 97 13 80
      positive-color: 186 31 30
      negative-color: 186 11 10

    orange-dark:
      background-color: 50 1 6
      primary-color: 24 97 58
      contrast-multiplier: 0.8
      positive-color: 24 100 78
      negative-color: 24 87 38

    black-white:
      light: true
      background-color: 0 0 95
      primary-color: 0 0 10
      positive-color: 0 0 30
      negative-color: 0 0 70

    purple:
      background-color: 231 15 21
      primary-color: 265 89 79
      contrast-multiplier: 1.2
      positive-color: 135 94 66
      negative-color: 0 100 67

    blue-dark:
      background-color: 240 21 15
      contrast-multiplier: 1.2
      primary-color: 217 92 83
      positive-color: 115 54 76
      negative-color: 347 70 65

    blue-light:
      light: true
      background-color: 220 23 95
      contrast-multiplier: 1.0
      primary-color: 217 92 53
      positive-color: 109 58 40
      negative-color: 347 87 44

pages:
  - name: Home
    columns:
      - size: small
        widgets:
        - type: custom-api
          title: "Schedule"
          cache: 30m
          url: "http://glances-ical-api:8076/events?url=${ICAL_URL}&limit=5"
          template: |
            <div>
            {{ range .JSON.Array "events" }}
              {{ $title := replaceMatches ",.*" "" (.String "name") }}
              {{ $loc := replaceMatches ",.*" "" (findMatch "HEY-.*" (.String "location")) }}
              {{ $time := findMatch "\\d{2}:\\d{2}" (.String "start") }}
              {{ $end   := findMatch "\\d{2}:\\d{2}" (.String "end") }}
              <div style="display:flex; justify-content:space-between; align-items:flex-start; padding:6px 0;">
                <div style="width:175px; text-align:left;">
                  <div class="size-h3">{{ $title }}</div>
                    <div style="font-size:0.85rem; color:var(--muted);">{{ $loc }}</div>
                </div>
                <div style="text-align: right; width: 75px;">
                  <div class="color-primary size-h3"{{ .String "start" | parseTime "rfc3339" | toRelativeTime }}></div>
                  <div class="color-primary"> 
                    <div style="font-size:0.85rem; color:var(--muted);">{{ $time }} - {{ $end }}</div>
                  </div>
                </div>
              </div>
            {{ end }}
            </div>

        - type: custom-api
          title: Steam User
          cache: 30m
          url: https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${STEAM_API_KEY}&steamids=${STEAM_USER}
          template: |
            <div class="steam-user-stats" style="display: flex; align-items: flex-start;">
              {{ $players := .JSON.Array "response.players" }}
              {{ if gt (len $players) 0 }}
                {{ $player := index $players 0 }}
                <div style="flex-shrink: 0; margin-right: 1em; display: flex; flex-direction: column; align-items: center;">
                  <a href="{{ $player.String "profileurl" }}"><img src="{{ $player.String "avatarmedium" }}" alt="Avatar" style="border-radius: var(--border-radius);"></a>
                </div>
                <div>
                  <h2 class="size-h3 color-primary">{{ $player.String "personaname" }}</h2>
                  <p>Status: 
                    {{ $status := $player.Int "personastate" }}
                    {{ if eq $status 0 }}<span class="color-negative">Offline</span>{{ end }}
                    {{ if eq $status 1 }}<span class="color-positive">Online</span>{{ end }}
                    {{ if eq $status 2 }}<span class="color-highlight">Busy</span>{{ end }}
                    {{ if eq $status 3 }}<span class="color-subdue">Away</span>{{ end }}
                    {{ if eq $status 4 }}<span class="color-subdue">Snooze</span>{{ end }}
                    {{ if eq $status 5 }}<span class="color-primary">Looking to trade</span>{{ end }}
                    {{ if eq $status 6 }}<span class="color-primary">Looking to play</span>{{ end }}
                  </p>
                  <p>Last Logoff: <span class="color-subdue" data-dynamic-relative-time="{{ $player.Int "lastlogoff" }}"></span></p>
                  <p>Account Created: <span class="color-subdue" data-dynamic-relative-time="{{ $player.Int "timecreated" }}"></span></p>
                  <p>Country: <span class="color-subdue">{{ $player.String "loccountrycode" }}</span></p>
                </div>
              {{ else }}
                <p class="color-negative">No player data found.</p>
              {{ end }}
            </div>

        - type: calendar
          first-day-of-week: monday

      - size: full
        widgets:
          - type: videos
            channels:
              - UCXuqSBlHAE6Xw-yeJA0Tunw # Linus Tech Tips
              - UCln9P4Qm3-EAY4aiEPmRwEA # Ado
              - UCZXW8E1__d5tZb-wLFOt8TQ # Bog
              - UC0e3QhIYukixgh5VVpKHH9Q # Code Bullet
              - UCHnyfMqiRRG1u-2MsSQLbXA # Veritasium
              - UCYO_jab_esuFRV4b17AJtAw # 3Blue1Brown
              - UCudlnfkmb1LgK4tSgctPNOQ # Dangerously Funny
              - UCROkFwHWMk5QeZK_LHJPu5g # doctor4t
              - UCsBjURrPoezykLs9EqgamOA # Fireship
              - UCjgpFI5dU-D1-kh9H1muoxQ # Hacksmith Industries
              - UCgdTVe88YVSrOZ9qKumhULQ # Hardware Haven
              - UCCzUftO8KOVkV4wQG1vkUvg # Houshou Marine
              - UCY1kMZp36IQSyNx_9h4mpCg # Mark Rober
              - UCtHaxi4GTYDpJgMSGy7AeSw # Michael Reeves
              - UCFhXFikryT4aFcLkLw2LBLA # NileRed
              - UC1D3yD4wlPMico0dss264XA # NileBlue
              - UCeP4Yv3s4RvS0-6d9OInRMw # Real Engineering
              - UC7zq5pBOUDf-xykfDgBwW2w # Trenton JP
              - UCt-HTfaCUz8QIoknqyXKYiw # Wirtual
              - UCILl8ozWuxnFYXIe2svjHhg #BPSpace

          - type: group
            widgets:
              - type: reddit
                subreddit: anime
                show-thumbnails: true
              - type: reddit
                subreddit: manga
                show-thumbnails: true
              - type: reddit
                subreddit: animenews
                show-thumbnails: true
              - type: reddit
                subreddit: unixporn
                show-thumbnails: true
              - type: reddit
                subreddit: homelab
                show-thumbnails: true
              - type: reddit
                subreddit: selfhosted
                show-thumbnails: true
          
          - type: to-do
          
      - size: small
        widgets:
        - type: weather
          location: Nijmegen
          units: metric
          hour-format: 24h
        
        - type: bookmarks
          groups:
            - title: school
              color: 265 89 79
              links:
                - title: school
                  url: https://hi.roc-nijmegen.nl
                - title: teams
                  url: https://teams.microsoft.com/v2
                - title: github
                  url: https://github.com
                - title: w3schools
                  url: https://www.w3schools.com
            
            - title: miscellaneous
              color: 135 94 66
              links:
                - title: lewd file host
                  url: https://lewd.host/dashboard
                - title: google translate
                  url: https://translate.google.com
                - title: chatgpt
                  url: https://chatgpt.com
                - title: claude
                  url: https://claude.ai

            - title: applications
              color: 24 97 58
              links:
                - title: jellyfin
                  url: https://jellyfin.m3v.dev
                - title: sonarr
                  url: https://sonarr.m3v.dev
                - title: radarr
                  url: https://radarr.m3v.dev
                - title: qbittorrent
                  url: https://qbit.m3v.dev
                - title: prowlarr
                  url: https://prowlarr.m3v.dev
                - title: komga
                  url: https://komga.m3v.dev
                - title: suwayomi
                  url: https://suwayomi.m3v.dev
                - title: bitwarden
                  url: https://vault.m3v.dev

  - name: Servers
    columns:
      - size: small
        widgets:
        - type: server-stats
          servers:
            - type: local
              name: main pc
              hide-mountpoints-by-default: true
        
        - type: custom-api
          title: Tailscale Devices
          title-url: https://login.tailscale.com/admin/machines
          url: https://api.tailscale.com/api/v2/tailnet/-/devices
          headers:
            Authorization: Bearer ${TAILSCALE_API_KEY}
          cache: 10m
          template: |
            {{/* User Variables */}}
            {{/* Set to true if you'd like an indicator for online devices */}}
            {{ $enableOnlineIndicator := false }}

            <style>
              .device-info-container {
                position: relative;
                overflow: hidden;
                height: 1.5em;
              }

              .device-info {
                display: flex;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }

              .device-ip {
                position: absolute;
                top: 0;
                left: 0;
                transform: translateY(-100%);
                opacity: 0;
                transition: transform 0.2s ease, opacity 0.2s ease;
              }

              .device-info-container:hover .device-info {
                transform: translateY(100%);
                opacity: 0;
              }

              .device-info-container:hover .device-ip {
                transform: translateY(0);
                opacity: 1;
              }

              .update-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-primary);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }

              .offline-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-negative);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }

              .online-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: var(--color-positive);
                display: inline-block;
                margin-left: 4px;
                vertical-align: middle;
              }

              .device-name-container {
                display: flex;
                align-items: center;
                gap: 8px;
              }

              .indicators-container {
                display: flex;
                align-items: center;
                gap: 4px;
              }
            </style>
            <ul class="list list-gap-10 collapsible-container" data-collapse-after="4">
              {{ range .JSON.Array "devices" }}
              <li>
                <div class="flex items-center gap-10">
                  <div class="device-name-container grow">
                    <span class="size-h4 block text-truncate color-primary">
                      {{ findMatch "^([^.]+)" (.String "name") }}
                    </span>
                    <div class="indicators-container">
                      {{ if (.Bool "updateAvailable") }}
                      <span class="update-indicator" data-popover-type="text" data-popover-text="Update Available"></span>
                      {{ end }}

                      {{ $lastSeen := .String "lastSeen" | parseTime "rfc3339" }}
                      {{ if not ($lastSeen.After (offsetNow "-10s")) }}
                      {{ $lastSeenTimezoned := $lastSeen.In now.Location }}
                      <span class="offline-indicator" data-popover-type="text"
                        data-popover-text="Offline - Last seen {{ $lastSeenTimezoned.Format " Jan 2 3:04pm" }}"></span>
                      {{ else if $enableOnlineIndicator }}
                        <span class="online-indicator" data-popover-type="text" data-popover-text="Online"></span>
                      {{ end }}
                    </div>
                  </div>
                </div>
                <div class="device-info-container">
                  <ul class="list-horizontal-text device-info">
                    <li>{{ .String "os" }}</li>
                    <li>{{ .String "user" }}</li>
                  </ul>
                  <div class="device-ip">
                    {{ .String "addresses.0"}}
                  </div>
                </div>
              </li>
              {{ end }}
            </ul>

        - type: Site status
          cache: 1m
          title: Sites
          style: compact
          sites:
            - title: Jellyfin
              url: https://jellyfin.m3v.dev
            - title: sonarr
              url: https://sonarr.m3v.dev
            - title: radarr
              url: https://radarr.m3v.dev
            - title: qbittorrent
              url: https://qbit.m3v.dev
            - title: prowlarr
              url: https://prowlarr.m3v.dev
            - title: komga
              url: https://komga.m3v.dev
            - title: suwayomi
              url: https://suwayomi.m3v.dev

      - size: full
        widgets:
          - type: custom-api
            title: Latest Episodes
            frameless: true
            cache: 5m
            options:
              base-url: ${JELLYFIN_URL}
              api-key: ${JELLYFIN_KEY}
              user-name: "m3v"
              library-name: "anime"
              mode: "nextup"
              item-count: "10"
              small-column: false
              show-thumbnail: true
              thumbnail-aspect-ratio: "default"
            template: |
              {{/* Required config options */}}
              {{ $baseURL := .Options.StringOr "base-url" "" }}
              {{ $apiKey := .Options.StringOr "api-key" "" }}
              {{ $userName := .Options.StringOr "user-name" "" }}

              {{/* Required config options for "latest" mode */}}
              {{ $libraryName := .Options.StringOr "library-name" "" }}

              {{/* Optional config options */}}
              {{ $mode := .Options.StringOr "mode" "latest" }}
              {{ $itemCount := .Options.StringOr "item-count" "10" }}
              {{ $mediaTypes := .Options.StringOr "media-types" "Movie,Episode,MusicAlbum" }}
              {{ $thumbAspectRatio := .Options.StringOr "thumbnail-aspect-ratio" "" }}
              {{ $isSmallColumn:= .Options.BoolOr "small-column" false }}
              {{ $showThumbnail := .Options.BoolOr "show-thumbnail" false }}
              {{ $showProgressBar := .Options.BoolOr "progress-bar" true }}

              {{/* Error message template */}}
              {{ define "errorMsg" }}
                <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">{{ . }}</p>
              {{ end }}

              {{/* Check required fields */}}
              {{ if or (eq $baseURL "") (eq $apiKey "") (eq $userName "") (eq $mode "") (and (eq $mode "latest") (eq $libraryName "")) }}
                {{ template "errorMsg" "Some required options are not set." }}
              {{ else }}

                {{/* Fetch user ID */}}
                {{ $userID := "" }}
                {{ $usersCall := newRequest (print $baseURL "/Users")
                    | withParameter "api_key" $apiKey
                    | withHeader "Accept" "application/json"
                    | getResponse }}

                {{ range $i, $user := $usersCall.JSON.Array "" }}
                  {{ if eq ($user.String "Name") $userName }}
                    {{ $userID = $user.String "Id" }}
                    {{ break }}
                  {{ end }}
                {{ end }}
                {{ if eq $userID "" }}
                  {{ template "errorMsg" (printf "User '%s' not found." $userName) }}
                {{ else }}

                  {{ $items := "" }}

                  {{ if eq $mode "latest" }}

                    {{/* Fetch library ID */}}
                    {{ $libraryID := "" }}
                    {{ $userViewsCall := newRequest (print $baseURL "/UserViews")
                        | withParameter "api_key" $apiKey
                        | withParameter "userId" $userID
                        | withHeader "Accept" "application/json"
                        | getResponse }}

                    {{ range $i, $item := $userViewsCall.JSON.Array "Items" }}
                      {{ if eq ($item.String "Name") $libraryName }}
                        {{ $libraryID = $item.String "Id" }}
                        {{ break }}
                      {{ end }}
                    {{ end }}

                    {{ if eq $libraryID "" }}
                      {{ template "errorMsg" (printf "Library '%s' not found." $libraryName) }}
                    {{ else }}
                      {{/* Fetch latest items */}}
                      {{ $latestCall := newRequest (print $baseURL "/Users/" $userID "/Items/Latest")
                          | withParameter "api_key" $apiKey
                          | withParameter "Limit" $itemCount
                          | withParameter "ParentId" $libraryID
                          | withParameter "IncludeItemTypes" $mediaTypes
                          | withParameter "GroupItems" "true"
                          | withHeader "Accept" "application/json"
                          | getResponse }}
                      {{ $items = $latestCall.JSON.Array "" }}
                    {{ end }}

                  {{ else if eq $mode "nextup" }}

                    {{/* Fetch next up items */}}
                    {{ $nextUpCall := newRequest (print $baseURL "/Shows/NextUp")
                      | withParameter "api_key" $apiKey
                      | withParameter "UserId" $userID
                      | withParameter "Limit" $itemCount
                      | withParameter "EnableResumable" "true"
                      | withHeader "Accept" "application/json"
                      | getResponse }}
                    {{ $items = $nextUpCall.JSON.Array "Items" }}

                  {{ else }}
                    {{ template "errorMsg" "Unknown mode, expected 'latest' or 'nextup'" }}
                  {{ end }}

                  {{ if eq (len $items) 0 }}
                    <p>No items found, start streaming something!</p>
                  {{ else }}

                    {{/* Display the item carousel */}}
                    <div class="carousel-container show-right-cutoff">
                      <div class="cards-horizontal carousel-items-container">
                        {{ range $n, $item := $items }}
                          {{/* Common item variables */}}
                          {{ $mediaType := $item.String "Type" }}
                          {{ $title := $item.String "Name" }}
                          {{ $itemID := $item.String "Id" }}

                          {{/* Media type specific variables */}}
                          {{ $seriesTitle := "" }}
                          {{ $artist := "" }}
                          {{ $seriesID := "" }}
                          {{ $season := "" }}
                          {{ $episode := "" }}
                          {{ $playPercentage := "" }}
                          {{ $unwatchedEpisodeCount := "" }}

                          {{ if eq $mediaType "Movie" }}
                          {{ else if eq $mediaType "Series" }}
                            {{ $unwatchedEpisodeCount = $item.Int "UserData.UnplayedItemCount" }}
                          {{ else if eq $mediaType "Episode" }}
                            {{ $unwatchedEpisodeCount = 1 }}
                            {{ $seriesTitle = $item.String "SeriesName" }}
                            {{ $seriesID = $item.String "SeriesId" }}
                            {{ $season = $item.Int "ParentIndexNumber" }}
                            {{ $episode = $item.Int "IndexNumber" }}

                            {{ if $item.Exists "UserData.PlayedPercentage" }}
                              {{ $playPercentage = $item.String "UserData.PlayedPercentage" }}
                            {{ end }}

                            {{/* For latest always refer to the series not individual episodes */}}
                            {{ if eq $mode "latest" }}
                              {{ $itemID = $seriesID }}
                              {{ $title = $seriesTitle }}
                            {{ end }}
                          {{ else if eq $mediaType "MusicAlbum" }}
                            {{ $artist = $item.String "AlbumArtist" }}
                          {{ end }}

                          {{ $linkURL := print $baseURL "/web/#/details?id=" $itemID }}
                          {{ $thumbURL := "" }}
                          {{ if not (eq $playPercentage "") }}
                            {{/* $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey "&percentPlayed=" $playPercentage */}}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ else }}
                            {{ $thumbURL = concat $baseURL "/Items/" $itemID "/Images/Primary?api_key=" $apiKey }}
                          {{ end }}

                          <a class="card widget-content-frame" href="{{ $linkURL | safeURL }}">
                            {{ if $showThumbnail }}
                              <div style="position: relative;">
                                <img src="{{ $thumbURL | safeURL }}"
                                  alt="{{ $title }} thumbnail"
                                  loading="lazy"
                                  class="media-server-thumbnail shrink-0"
                                  style="
                                    object-fit: fill;
                                    border-radius: var(--border-radius) var(--border-radius) 0 0;
                                    width: 100%;
                                    display: block;
                                    {{ if eq $thumbAspectRatio "square" }}aspect-ratio: 1;
                                    {{ else if eq $thumbAspectRatio "portrait" }}aspect-ratio: 2/3;
                                    {{ else if eq $thumbAspectRatio "landscape" }}aspect-ratio: 16/9;
                                    {{ else }}aspect-ratio: initial;
                                    {{ end }}
                                  "
                                />

                                {{ if and ($showProgressBar) (not (eq $playPercentage "")) }}
                                  <div style="
                                    position: absolute;
                                    bottom: 8px;
                                    left: 8px;
                                    right: 8px;
                                    height: 6px;
                                    border-radius: var(--border-radius);
                                    overflow: hidden;
                                    background-color: rgba(255, 255, 255, 0.2);
                                  ">
                                    <div style="
                                      width: {{ print $playPercentage "%" }};
                                      height: 100%;
                                      border-radius: var(--border-radius) 0 0 var(--border-radius);
                                      background-color: var(--color-primary)
                                    "></div>
                                  </div>
                                {{ end }}
                              </div>
                            {{ end }}

                            <div class="grow padding-inline-widget margin-top-10 margin-bottom-10">
                              <ul class="flex flex-column justify-evenly margin-bottom-3 {{ if $isSmallColumn }}size-h6{{ end }}" style="height: 100%;">
                                {{ if eq $mode "latest" }}
                                  {{ if or (eq $mediaType "Series") (eq $mediaType "Episode") }}
                                    <ul class="list-horizontal-text flex-nowrap">
                                      <li class="color-primary shrink-0">{{ $unwatchedEpisodeCount }}</li>
                                      <li class="text-truncate">{{ $title }}</li>
                                    </ul>
                                  {{ else if eq $mediaType "MusicAlbum" }}
                                    <ul class="list-horizontal-text flex-nowrap">
                                      <li class="color-primary text-truncate">{{ $artist }}</li>
                                      <li class="text-truncate">{{ $title }}</li>
                                    </ul>
                                  {{ else }}
                                    <li class="text-truncate">{{ $title }}</li>
                                  {{ end }}
                                {{ else if eq $mode "nextup" }}
                                  <ul class="list-horizontal-text flex-nowrap">
                                    <li class="color-primary shrink-0">S{{ $season }}E{{ $episode }}</li>
                                    <li class="text-truncate">{{ $seriesTitle }}</li>
                                  </ul>
                                  <li class="text-truncate">{{ $title }}</li>
                                {{ end }}
                              </ul>
                            </div>
                          </a>
                        {{ end }}
                      </div>
                    </div>
                  {{ end }}

                {{ end }}

              {{ end }}
            
          - type: docker-containers
            hide-by-default: false
        
      - size: small
        widgets:
        - type: custom-api
          title: "Jellyfin Stats"
          base-url: ${JELLYFIN_URL}
          options:
            url: ${JELLYFIN_URL}
            key: ${JELLYFIN_KEY}
          template: |
            {{ $url := .Options.StringOr "url" "" }}
            {{ $key := .Options.StringOr "key" "" }}

            {{- if or (eq $url "") (eq $key "") -}}
            
              <p>Error: The URL or API Key was not configured in the widget options.</p>
              
            {{- else -}}

              {{- $requestUrl := printf "%s/emby/Items/Counts?api_key=%s" $url $key -}}
              {{- $jellyfinData := newRequest $requestUrl | getResponse -}}

              {{- if eq $jellyfinData.Response.StatusCode 200 -}}
                <div class="flex flex-column gap-5">
                  <div class="flex justify-between text-center">
                    
                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "MovieCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">Movies</div>
                    </div>

                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SeriesCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">TV Shows</div>
                    </div>

                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "EpisodeCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">Episodes</div>
                    </div>

                    <div>
                      <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SongCount" | formatNumber }}</div>
                      <div class="size-h5 uppercase">Songs</div>
                    </div>

                  </div>
                </div>
              {{- else -}}
                <p>Failed: {{ $jellyfinData.Response.Status }}</p>
              {{- end -}}
            {{- end -}}
        
        - type: custom-api
          title: Prowlarr Indexers
          cache: 1m
          options:
            url: "${PROWLARR_URL}"
            base-url: ${PROWLARR_API_URL}
            api-key: ${PROWLARR_KEY}
            collapse-after: ${PROWLARR_COLLAPSE_AFTER}
          template: |
            {{ $apiBaseUrl := .Options.StringOr "base-url" "" }}
            {{ $key := .Options.StringOr "api-key" "" }}
            {{ $url := .Options.StringOr "url" "" }}
            {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}

            {{ if or (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
              <div class="widget-error-header">
                  <div class="color-negative size-h3">ERROR</div>
                  <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                  </svg>
                </div>
                <p class="break-all">
                  Some options are not set or malformed
                    <table style="border-spacing: 1rem;">
                      <tr>
                        <td><strong>PROWLARR_URL & PROWLARR_API_URL</strong> <br/> should include http(s):// and port if needed</td>
                      </tr>
                      <tr>
                        <td><strong>PROWLARR_KEY</strong> <br/> must be set (Settings > General > Security)</td>
                      </tr>
                    </table> 
                </p>
            {{ else }}

              {{ $indexUrl := printf "%s/api/v1/indexer" $apiBaseUrl }}

              {{ $indexData := newRequest $indexUrl
                | withHeader "Accept" "application/json"
                | withHeader "X-Api-Key" $key
                | getResponse }}

              {{ if eq $indexData.Response.StatusCode 200 }}
                <style>
                  .prowlarr-indexers .prowlarr-index-item
                  {
                    align-items: center;        
                  }
                  .prowlarr-indexers .prowlarr-index-item > span{
                    text-transform: capitalize;
                    background: var(--color-background);
                    padding: 0.2rem 0.75rem;
                    border: 1px solid var(--color-widget-content-border);
                    border-radius: var(--border-radius);
                    font-size: var(--font-size-tiny);
                  }
                </style>
          
                <ul class="prowlarr-indexers list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">

                  {{ range $indexData.JSON.Array "" }}
                    {{ $isEnabled := .String "enable" }}
              
                    <li class="flex items-center gap-12 prowlarr-index-item">
                      <a href="{{ $url }}" target="_blank" class="size-title-dynamic color-highlight text-truncate block grow">{{ .String "name" }}</a>
                      <span>{{ .String "privacy" }}</span>
                      {{ if eq $isEnabled "true" }}
                        <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Enabled" aria-label="Enabled">
                          <div class="monitor-site-status-icon-compact" title="Enabled">
                            <svg fill="var(--color-positive)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      {{ else }}
                        <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Disabled" aria-label="Disabled">
                          <div class="monitor-site-status-icon-compact" title="Disabled">
                            <svg fill="var(--color-negative)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      {{ end }}
                      
                    </li>
                  {{ end }}

                </ul>
              {{ else }}
                <p>Failed to fetch data (Status: {{ $indexData.Response.StatusCode }})</p>
              {{ end }}

            {{ end }}

        - type: custom-api
          title: qBittorrent
          cache: 1m
          options:
            hide-summary: false
            collapsible: true
            hide-bar: false
            hide-completed: false
            hide-inactive: false
          subrequests:
            info:
              url: "http://${QBW_URL}/qb/torrents"
              method: GET
              headers:
                Authorization: "Bearer ${AUTH_TOKEN}"
          template: |
            {{ $info := .Subrequest "info" }}
            {{ $torrents := $info.JSON.Array "torrents" }}
            {{ $hideCompleted := .Options.BoolOr "hide-completed" false }}
            {{ $hideInactive := .Options.BoolOr "hide-inactive" false }}
            {{ $hideBar := .Options.BoolOr "hide-bar" false }}
            
            {{ $summary := $info.JSON }}
            
            {{ if eq (len $torrents) 0 }}
              <div>No torrents found.</div>
            {{ else }}
            
              {{ if not (.Options.BoolOr "hide-summary" false) }}
              <!-- Summary -->
              <div style="display:flex; align-items:center; justify-content:center; text-align:center; margin-bottom:16px; color:#ccc; font-weight:normal; font-size:1.1em;">
                  <div style="flex:1;">
                      <div style="font-size:1em; font-weight:normal;">
                          {{ printf "%.2f MB/s" (div (toFloat ($summary.Int "total_download_speed")) 1048576) }}
                      </div>
                      <div style="font-size:0.75em; color:#aaa; margin-top:2px;">DOWNLOAD</div>
                  </div>
                  <div style="width:2px; height:2.5rem; margin:0 1rem; border-radius:2px; align-self:center; background:linear-gradient(to bottom, transparent, rgba(255,255,255,0.1) 20%, rgba(255,255,255,0.1) 80%, transparent);"></div>
                  <div style="flex:1;">
                      <div style="font-size:1em; font-weight:normal;">{{ $summary.Int "seeding_count" }}</div>
                      <div style="font-size:0.75em; color:#aaa; margin-top:2px;">SEEDING</div>
                  </div>
                  <div style="width:2px; height:2.5rem; margin:0 1rem; border-radius:2px; align-self:center; background:linear-gradient(to bottom, transparent, rgba(255,255,255,0.1) 20%, rgba(255,255,255,0.1) 80%, transparent);"></div>
                  <div style="flex:1;">
                      <div style="font-size:1em; font-weight:normal;">{{ $summary.Int "leeching_count" }}</div>
                      <div style="font-size:0.75em; color:#aaa; margin-top:2px;">LEECHING</div>
                  </div>
              </div>
              {{ end }}
            
              <div class="container-list-cup">
                <ul class="list collapsible-container" data-collapse-after="3" style="list-style:none; margin:0; padding:0;">
                  {{ range $t := $torrents }}
                    {{ $state := $t.String "state" }}
                    {{ $downloaded := $t.Int "downloaded" }}
                    {{ $size := $t.Int "size" }}
                    {{ $progress := mul ($t.Float "progress") 100 }}
            
                    {{ if and $hideCompleted (ge $downloaded $size) }}{{ continue }}{{ end }}
                    {{ if and $hideInactive (not (or (eq $state "downloading") (eq $state "forcedDL") (eq $state "uploading") (eq $state "forcedUP"))) }}{{ continue }}{{ end }}
            
                    {{ $isCompleted := ge $downloaded $size }}
                    {{ $isSeeding := or (eq $state "uploading") (eq $state "forcedUP") }}
            
                    {{ $icon := "?" }}
                    {{ if $isCompleted }}{{ $icon = "✔" }}
                    {{ else if or (eq $state "downloading") (eq $state "forcedDL") }}{{ $icon = "↓" }}
                    {{ else if $isSeeding }}{{ $icon = "↑" }}
                    {{ else if or (eq $state "pausedDL") (eq $state "stoppedDL") (eq $state "pausedUP") (eq $state "stalledDL") (eq $state "stalledUP") (eq $state "queuedDL") (eq $state "queuedUP") }}{{ $icon = "❚❚" }}
                    {{ else if or (eq $state "error") (eq $state "missingFiles") }}{{ $icon = "!" }}
                    {{ else if or (eq $state "checkingDL") (eq $state "checkingUP") (eq $state "allocating") }}{{ $icon = "…" }}
                    {{ else if eq $state "checkingResumeData" }}{{ $icon = "⟳" }}
                    {{ end }}
            
                    {{ $name := $t.String "name" }}
                    {{ $shortName := $name }}
                    {{ if gt (len $name) 20 }}{{ $shortName = printf "%s..." (slice $name 0 20) }}{{ end }}
            
                    {{ $fmtDownloaded := "" }}
                    {{ $fmtSize := "" }}
                    {{ if gt $size 1073741824 }}
                      {{ $fmtDownloaded = printf "%.2f GB" (div (toFloat $downloaded) 1073741824) }}
                      {{ $fmtSize = printf "%.2f GB" (div (toFloat $size) 1073741824) }}
                    {{ else }}
                      {{ $fmtDownloaded = printf "%.2f MB" (div (toFloat $downloaded) 1048576) }}
                      {{ $fmtSize = printf "%.2f MB" (div (toFloat $size) 1048576) }}
                    {{ end }}
            
                    {{ $eta := $t.Int "eta" }}
                    {{ $etaStr := "" }}
                    {{ if gt $eta 0 }}
                      {{ $h := div $eta 3600 }}
                      {{ $m := div (mod $eta 3600) 60 }}
                      {{ if ge $h 2400 }}{{ $etaStr = "∞" }}
                      {{ else }}{{ $etaStr = printf "%dh %dm" $h $m }}{{ end }}
                    {{ else if eq $eta 0 }}{{ $etaStr = "0m" }}
                    {{ else }}{{ $etaStr = "∞" }}
                    {{ end }}
            
                    <li style="margin-bottom:12px;">
                      <div style="display:inline-block; max-width:100%;">
                        <h2 style="font-size: 1.2em; margin-bottom: 4px; color: #ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                          {{ $icon }} {{ $shortName }}
                        </h2>
            
                        {{ if and (not $hideBar) (not $isCompleted) (not $isSeeding) }}
                          <div style="height: 20px; background: #2b2b2b; border-radius: 5px; overflow: hidden; position: relative; font-size: 0.8em; color: #e0e0e0; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; box-sizing: border-box;">
                            <div style="width: {{ printf "%.1f" $progress }}%; height: 100%; background: linear-gradient(90deg, #555555, #888888); position: absolute; top: 0; left: 0;"></div>
                            <div style="position: relative; z-index: 1; width: 100%; display: flex; justify-content: space-between;">
                              <span>{{ $fmtDownloaded }} / {{ $fmtSize }}</span>
                              <span>{{ $etaStr }}</span>
                            </div>
                          </div>
                        {{ end }}
                      </div>
                    </li>
            
                  {{ end }}
                </ul>
              </div>
            
            {{ end }}
